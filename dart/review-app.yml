# to include this in various files, we might prepend multiple slashes, see:
# https://gitlab.com/gitlab-org/gitlab/-/issues/28987
include:
  - local: '//dart/common.yml'

variables:
  REVIEW_DOMAIN: web-review.famedly.de
  REVIEW_HOSTNAME: ${REVIEW_DOMAIN}
  REVIEW_USERNAME: web-review
  REVIEW_FILE_PATH: /opt/web-review/web/${CI_ENVIRONMENT_SLUG}
  REVIEW_ENVIRONMENT_NAME: review/${CI_PROJECT_NAME}-${CI_MERGE_REQUEST_IID}
  REVIEW_URL: https://${CI_ENVIRONMENT_SLUG}.${REVIEW_DOMAIN}

build_web:
  extends: .dart_base
  script: [ "echo test" ]
  rules:
    - if: '$FAMEDLY_REVIEW_APP && $CI_MERGE_REQUEST_IID'
      exists:
        - 'pubspec.yaml'

dart_review_app:
  extends: .dart_base
  stage: deploy
  needs: [ build_web ]
  script:
    - mv web public
    - apk add rsync
    - rsync -av --delete public/ ${REVIEW_USERNAME}@${REVIEW_HOSTNAME}:${REVIEW_FILE_PATH}
  environment:
    name: $REVIEW_ENVIRONMENT_NAME
    url: $REVIEW_URL
    on_stop: dart_stop_review
    auto_stop_in: 1 week
  rules:
    - if: '$FAMEDLY_REVIEW_APP && $CI_MERGE_REQUEST_IID'
      exists:
        - 'pubspec.yaml'

dart_stop_review:
  extends: .dart_base
  stage: deploy
  variables:
    GIT_STRATEGY: none
  script:
    - ssh ${REVIEW_USERNAME}@${REVIEW_HOSTNAME} rm -rf ${REVIEW_FILE_PATH}
  environment:
    name: $REVIEW_ENVIRONMENT_NAME
    action: stop
  rules:
    - if: '$FAMEDLY_REVIEW_APP && $CI_MERGE_REQUEST_IID'
      exists:
        - 'pubspec.yaml'
      when: manual
      allow_failure: true

